# æ¶æ„è®¾è®¡æ–‡æ¡£ï¼šå¢å¼ºå‹æµå¼åè®® (Data Stream Protocol)

æœ¬æŒ‡å—ä»‹ç»äº†é’ˆå¯¹åŸæ–‡æ‰€åšçš„**ä¸»è¦ç»“æ„åŒ–ä¼˜åŒ–**å’Œ**æ·»åŠ çš„å›¾è¡¨ç±»å‹**ï¼š
- **ç»“æ„åŒ–é‡ç»„**ï¼šå°†å¤æ‚çš„æµå¼åè®®æ‹†è§£ä¸ºâ€œæœåŠ¡ç«¯ç¼–ç â€ä¸â€œå®¢æˆ·ç«¯æ¶ˆè´¹â€ä¸¤ä¸ªæ ¸å¿ƒè§†è§’ã€‚
- **æ·»åŠ å›¾è¡¨**ï¼šå¼•å…¥äº†åè®®æ—¶åºå›¾ (Sequence Diagram) å’Œ å¸§ç»“æ„ç¤ºæ„å›¾ (Graph)ï¼Œç›´è§‚å±•ç¤ºå¤šé€šé“æ•°æ®çš„åŒæ­¥é€»è¾‘ã€‚

## 1. èƒŒæ™¯ (Background)
åœ¨æ„å»ºç”Ÿäº§çº§ AI åº”ç”¨æ—¶ï¼Œç®€å•çš„æ–‡æœ¬æµï¼ˆSSEï¼‰å·²æ— æ³•æ»¡è¶³å¤æ‚çš„äº¤äº’éœ€æ±‚ã€‚å¼€å‘è€…å¾€å¾€éœ€è¦åœ¨å‘é€ AI å›å¤çš„åŒæ—¶ï¼ŒåŒæ­¥ä¼ é€’å¼•ç”¨æ¥æºã€å·¥å…·çŠ¶æ€ã€å»ºè®®é—®é¢˜ç­‰ç»“æ„åŒ–å…ƒæ•°æ®ã€‚Vercel AI SDK çš„ **Data Stream Protocol** æ—¨åœ¨é€šè¿‡å• HTTP è¿æ¥å®ç°è¿™ç§å¤šç»´æ•°æ®çš„å®æ—¶åŒæ­¥ã€‚

## 2. æ ¸å¿ƒä»·å€¼ï¼šä¸ºä»€ä¹ˆå®ƒä¸ä»…æ˜¯â€œæµâ€ï¼Ÿ (Core Value)

åœ¨ä¼ ç»Ÿçš„ LLM å¼€å‘ä¸­ï¼Œæµå¼ä¼ è¾“é€šå¸¸åªèƒ½å‘é€çº¯æ–‡æœ¬ã€‚å¦‚æœä½ æƒ³åœ¨ AI å›å¤çš„åŒæ—¶å±•ç¤ºâ€œæ¥æºé“¾æ¥â€æˆ–â€œä¸‹ä¸€æ­¥å»ºè®®â€ï¼Œé€šå¸¸ä¼šé™·å…¥ä»¥ä¸‹çª˜å¢ƒï¼š
- **æ–¹æ¡ˆ Aï¼šå‘èµ·ä¸¤æ¬¡è¯·æ±‚**ã€‚å…ˆç­‰ AI è¯´å®Œï¼Œå‰ç«¯å†å‘ä¸€ä¸ªè¯·æ±‚é—®â€œè¯·ç»™æˆ‘æ¥æºâ€ã€‚è¿™ä¼šå¯¼è‡´ç”¨æˆ·æ„ŸçŸ¥çš„æ€»å»¶è¿Ÿç¿»å€ã€‚
- **æ–¹æ¡ˆ Bï¼šåœ¨æ–‡æœ¬ä¸­ç¡¬ç¼–ç  JSON**ã€‚è®© AI åœ¨æµä¸­è¿”å› `[SOURCE:...]`ã€‚è¿™ä¸ä»…ç ´åäº†æµçš„å¹³æ»‘æ˜¾ç¤ºï¼Œè¿˜ææ˜“å¯¼è‡´å‰ç«¯è§£æå‡ºé”™ï¼ˆç‰¹åˆ«æ˜¯æµè¢«åˆ‡ç¢æ—¶ï¼‰ã€‚

**Data Stream Protocol é€šè¿‡â€œå¸¦æ ‡ç­¾çš„æ•°æ®å¸§ (Labeled Frames)â€å½»åº•è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š**

### 2.1 æ ¸å¿ƒæ”¶ç›Š (Key Benefits)

1.  **å•è¿æ¥åŒæ­¥ (Single-Stream Synchronization)**:
    - **åŸç†**ï¼šåœ¨ä¸€ä¸ª HTTP è¿æ¥ä¸­å¹¶è¡Œä¼ è¾“å¤šç§æ•°æ®ç±»å‹ã€‚
    - **ä»·å€¼**ï¼šæ¨¡å‹åœ¨åå­—ï¼ˆæ–‡æœ¬å¸§ `0:`ï¼‰çš„åŒæ—¶ï¼Œåç«¯å¯ä»¥å¼‚æ­¥æ³¨å…¥ä¸šåŠ¡æ•°æ®ï¼ˆæ•°æ®å¸§ `d:`ï¼‰ã€‚æ— éœ€äºŒæ¬¡å¾€è¿”ï¼Œæå¤§é™ä½äº†å¤æ‚äº¤äº’çš„å»¶è¿Ÿã€‚

2.  **æ‰“ç ´â€œé»‘ç›’ç”Ÿæˆâ€ (Transparency & Feedback)**:
    - **åŸç†**ï¼šåˆ©ç”¨æ•°æ®å¸§å®æ—¶æ¨é€ä¸­é—´çŠ¶æ€ã€‚
    - **ä»·å€¼**ï¼šç”¨æˆ·ä¸å†åªæ˜¯ç›¯ç€è·³åŠ¨çš„å…‰æ ‡ï¼Œè€Œæ˜¯èƒ½çœ‹åˆ°â€œæ­£åœ¨æ£€ç´¢æ•°æ®åº“...â€ã€â€œæ­£åœ¨åˆ†æå¼•ç”¨æ¥æº...â€ç­‰å®æ—¶åé¦ˆã€‚è¿™ç§â€œæ‰€è§å³æ‰€å¾—â€çš„è¿›åº¦æ„Ÿèƒ½æ˜¾è‘—é™ä½ç”¨æˆ·çš„è·³å‡ºç‡ã€‚

3.  **åè®®çº§è§£è€¦ (Protocol-level Decoupling)**:
    - **åŸç†**ï¼šå°†æ–‡æœ¬ã€å…ƒæ•°æ®ã€å·¥å…·è°ƒç”¨ã€é”™è¯¯ä¿¡æ¯åˆ†åˆ«åŒ…è£…åœ¨ä¸åŒçš„å¸§ç±»å‹ä¸­ï¼ˆå¦‚ `0:`, `d:`, `t:`, `e:`ï¼‰ã€‚
    - **ä»·å€¼**ï¼šå‰ç«¯ `useChat` ä¼šè‡ªåŠ¨è¯†åˆ«è¿™äº›æ ‡ç­¾ã€‚å¼€å‘è€…ä¸éœ€è¦å†™å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼æ¥æå–æ–‡æœ¬ä¸­çš„æ•°æ®ï¼Œå®ç°äº†â€œåç«¯æŒ‰éœ€å‘ï¼Œå‰ç«¯å“åº”å¼æ”¶â€çš„å·¥ç¨‹é—­ç¯ã€‚

4.  **æ™ºèƒ½çŠ¶æ€ç®¡ç† (Smart State Injection)**:
    - **åŸç†**ï¼šæ”¯æŒåœ¨æµçš„ä»»æ„ä½ç½®æ’å…¥æ•°æ®ã€‚
    - **ä»·å€¼**ï¼š
        - **æµå¼€å§‹å‰**ï¼šæ¨é€ä¸Šä¸‹æ–‡ ID æˆ–åˆå§‹ UI é…ç½®ã€‚
        - **æµè¿‡ç¨‹ä¸­**ï¼šæ¨é€å½“å‰å·¥å…·è°ƒç”¨çš„ä¸­é—´ç»“æœã€‚
        - **æµç»“æŸå**ï¼šæ¨é€å»ºè®®é—®é¢˜ï¼ˆFollow-up Questionsï¼‰æˆ–æˆæœ¬ç»Ÿè®¡ï¼ˆToken Usageï¼‰ã€‚

### 2.2 åœºæ™¯å¯¹æ¯”

## 3. åŸºç¡€è®¾æ–½ä¿éšœ (Infrastructure Continuity)
ä¸ºäº†ç¡®ä¿æµå¼å“åº”çš„è¿ç»­æ€§ï¼Œé™¤äº†åè®®å±‚çš„è®¾è®¡ï¼Œè¿˜éœ€è¦åœ¨åŸºç¡€è®¾æ–½å±‚å¼•å…¥å¯é æ€§ç¼–æ’ã€‚

å…³äºå¦‚ä½•åˆ©ç”¨ SDK çš„ `experimental_fallback` å’Œ `experimental_loadBalance` å®ç°é«˜å¯ç”¨è·¯ç”±ï¼Œè¯·å‚é˜… [è·¯ç”±ç­–ç•¥æ·±åº¦åˆ†æï¼šåŸç”Ÿ SDK å¯é æ€§ç¼–æ’](./enterprise-routing/STRATEGIES_ANALYSIS.md#8-native-sdk-reliability-orchestration--åŸç”Ÿ-sdk-å¯é æ€§ç¼–æ’)ã€‚

## 4. ç³»ç»Ÿè®¾è®¡ (Design)

### 4.1 å¢å¼ºå‹æµå¼åè®®æ¶æ„è®¾è®¡
```mermaid
graph TD
    subgraph Server ["æœåŠ¡ç«¯ (Node.js/Next.js)"]
        A["streamText() æ ¸å¿ƒé€»è¾‘"]
        B["StreamData å®¹å™¨"]
        C["Data Stream Protocol ç¼–ç å™¨"]
        
        A -->|"0: æ–‡æœ¬å—"| C
        B -->|"d: è‡ªå®šä¹‰å…ƒæ•°æ®"| C
        A -.->|"e: ç»“æŸæ§åˆ¶å¸§"| C
    end

    subgraph Transport ["ä¼ è¾“å±‚ (HTTP Stream)"]
        D["å• HTTP è¿æ¥<br/>(Content-Type: text/plain; charset=utf-8)"]
    end

    subgraph Client ["å®¢æˆ·ç«¯ (Frontend)"]
        E["useChat / useObject Hooks"]
        F["UI æ¸²æŸ“å±‚"]
        G["çŠ¶æ€ç®¡ç† (Metadata Store)"]
        
        E -->|"è§£æ 0:"| F
        E -->|"è§£æ d:"| G
    end

    C --> D
    D --> E
    G -.->|"å“åº”å¼æ›´æ–°"| F

    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#0075ff,stroke:#fff,color:#fff
```

### 4.2 åè®®æ¶æ„å›¾ (é€»è¾‘è§†å›¾)
```mermaid
graph TD
    subgraph App_Server ["(1) æ‰§è¡Œç¯å¢ƒ"]
        A["streamText æ ¸å¿ƒ"]
        B["StreamData å®ä¾‹"]
    end

    subgraph Encoder ["(2) åè®®ç¼–ç å™¨ (Frames Encoder)"]
        C{"å¸§ç±»å‹åˆ¤å®š"}
        C -->|"0:"| D["æ–‡æœ¬æ•°æ®å¸§"]
        C -->|"d:"| E["è‡ªå®šä¹‰æ•°æ®å¸§"]
        C -->|"e:"| F["æ§åˆ¶/é”™è¯¯å¸§"]
    end

    subgraph Transport ["(3) ä¼ è¾“å±‚"]
        G["HTTP Chunked Stream<br/>(text/plain)"]
    end

    subgraph Client ["(4) å®¢æˆ·ç«¯è§£æ (Hooks)"]
        H["useChat / useObject"]
        I["UI æ¸²æŸ“ç»„ä»¶"]
        J["Metadata Store"]
    end

    A -->|"ç”Ÿæˆæ–‡æœ¬"| C
    B -->|"append() æ•°æ®"| C
    C --> G
    G --> H
    H -->|"è§£æ 0:"| I
    H -->|"è§£æ d:"| J
    J -.->|"æ›´æ–°çŠ¶æ€"| I
```

### 4.3 äº¤äº’æ—¶åºå›¾
```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· (Browser)
    participant Server as æœåŠ¡ç«¯ (Node.js)
    participant LLM as æ¨¡å‹ (Ollama/OpenAI)

    User->>Server: å‘é€ Prompt
    Server->>Server: åˆå§‹åŒ– StreamData
    Server->>User: å‘é€å¸§ "d:{status: 'initializing'}"
    
    Server->>LLM: è°ƒç”¨æ¨¡å‹æµ
    LLM-->>Server: è¿”å›ç¬¬ä¸€ä¸ª Token
    Server->>User: å‘é€å¸§ "0:'é‡å­è®¡ç®—...'"
    
    Note over Server, LLM: è¿‡ç¨‹ä¸­è§¦å‘å·¥å…·è°ƒç”¨
    Server->>User: å‘é€å¸§ "d:{tool: 'search', query: '...'}"
    
    LLM-->>Server: å®Œæˆç”Ÿæˆ
    Server->>User: å‘é€å¸§ "d:{suggestions: ['Q1', 'Q2']}"
    Server->>User: å‘é€æ§åˆ¶å¸§ "e:{finishReason: 'stop'}"
    
    Server->>User: å…³é—­ HTTP æµ
```

## 5. ç»“è®º (Conclusion)
Data Stream Protocol ä¸ä»…ä»…æ˜¯ä¸€ä¸ªä¼ è¾“åè®®ï¼Œå®ƒæ˜¯ AI åº”ç”¨ä»â€œé»‘ç›’ç”Ÿæˆâ€å‘â€œé€æ˜äº¤äº’â€è¿›åŒ–çš„åŸºç¡€è®¾æ–½ã€‚é€šè¿‡ç»Ÿä¸€çš„å¸§æ ¼å¼ï¼Œå®ƒæå¤§åœ°é™ä½äº†å‰ç«¯å¤„ç†å¤æ‚ AI äº¤äº’çŠ¶æ€çš„éš¾åº¦ã€‚

### ğŸš€ æœ€ä½³å®è·µå»ºè®®
- **å°½æ—©å‘é€å…ƒæ•°æ®**ï¼šåœ¨æµå¼€å§‹å‰å‘é€åˆå§‹çŠ¶æ€ï¼Œå‡å°‘ç”¨æˆ·çš„ç„¦è™‘æ„Ÿã€‚
- **ç²¾ç®€å¸§ä½“ç§¯**ï¼šè™½ç„¶åè®®æ”¯æŒå‘é€å¤§é‡ JSONï¼Œä½†ä¸ºäº†ä¿è¯æµçš„æµç•…æ€§ï¼Œåº”é¿å…å‘é€è¿‡å¤§çš„äºŒè¿›åˆ¶æˆ–è¶…é•¿æ–‡æœ¬å…ƒæ•°æ®ã€‚
- **å§‹ç»ˆå…³é—­å®¹å™¨**ï¼šåœ¨ `onFinish` å›è°ƒä¸­è°ƒç”¨ `data.close()`ï¼Œé˜²æ­¢å‰ç«¯è¿æ¥æŒ‚èµ·ã€‚

---

**ğŸ¤– åä½œè¯´æ˜**
> *æœ¬å¯è§†åŒ–æ–‡æ¡£åŸºäºæ¶æ„å¸ˆæ•™æˆ `/prof` çš„æ·±åº¦åˆ†æç”Ÿæˆï¼Œå¹¶ç”± `vizdoc` è¿›è¡Œç»“æ„åŒ–ä¸å›¾è¡¨å®ç°ã€‚*
